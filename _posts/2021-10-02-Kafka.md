---
layout: post
title: ğŸ“•ã€Toolã€‘Kafka basic idea
date: 2021-10-02 00::wq!00
---

Note for Kafka videos by confluent, which provides great help.
[Link][https://www.youtube.com/watch?v=jY02MB-sz8I&list=RDCMUCmZz-Gj3caLLzEWBtbYUXaA&index=3]

## ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯ä¸­é—´ä»¶ï¼Ÿ 

äº‹ä»¶é©±åŠ¨çš„ç¨‹åºè¶Šæ¥è¶Šå¤šï¼Œä»ä»¥å‰çš„é™æ€åˆ°å¦‚ä»Šä¸æ–­çš„äº‹ä»¶æµï¼Œå¯¹äºä¸€ä¸ªç¨‹åºéœ€è¦å¤„ç†çš„äº‹æƒ…æ›´åŠ å¤šäº†ï¼Œæ›´è¿½æ±‚å®æ—¶æ€§ï¼Œéœ€è¦ä¸€ä¸ªä¸­é—´ä»¶æœ‰ä¸€ä¸‹ç‰¹ç‚¹

1. Single platform to connect every one to every event
2. Real-time stream of events
3. All events stored fro historical view

## Element

**Producers**: The application which generate data and push(write) into the kafka cluster
**Kafka cluster**: The place store data, it contains many brokers
**Consumers**: The applicatin which poll(read) data from the Kafka cluster
**Zookeeper**: Used for cluster management, failure detection & recovery, basically all the distrubuted stuff.

*Producers and consumers are total decoupling.*

![Kafka Element](https://typora-1302119905.cos.ap-nanjing.myqcloud.com/Coding/%E6%88%AA%E5%B1%8F2021-10-01%20%E4%B8%8B%E5%8D%885.49.32.png)

**Topic**: It's like categories used to organize message. Producers write to topic and consumer read from topic. Topic å°±æ˜¯æ•°æ®ä¸»é¢˜ï¼Œæ˜¯æ•°æ®è®°å½•å‘å¸ƒçš„åœ°æ–¹,å¯ä»¥ç”¨æ¥åŒºåˆ†ä¸šåŠ¡ç³»ç»Ÿã€‚[Linkd](https://kafka.apachecn.org/intro.html)
**Partition**: Topic are partitioned across multiple nodes physically, and the node here is partition, each node is in different broker.
**Broker**: 

1. Broken handles many partitions
2. Partition stored on Broker's disk
3. Partition is log file, append only
4. Broker replication: for a partition in broker A, that it would have a copy of it in other broker. So there would be a leader partition and a follower partition. Follower partition need to make sure update from the leader partition as quickly as possible.

*Why we need partition?*

1. Scalable
2. Replication

*How do we know which partition the message go to when writing as a producer?*

1. Depends on Kafka, Kafka use round robin method to decide which partition the message go to.
2. When writing a message, passing a key to Kafka, Kafka would use `hash(key) % number_of_partitions` to decide which partition to write into.
3. Customise by user

*When we need to method 2 above?*
When the user want some kind of message with ordered, and the order of event is important, then just give those message a same key. By using method 2, all those data would go to one partition. And In the partition, it could make sure that those message is ordered by writing time.

## How Kafka works

#### **Partition leadership & Replication**

The producers and customers are always '*communicate*' with the leader of each partition

If one of the broker dies, for example broker 4, a new leader for partition 4 would be elected right away, can continue the writing and reading for this partition

![Partition Leader & Replication](https://typora-1302119905.cos.ap-nanjing.myqcloud.com/Coding/Partition-Leadership.png)

#### **Data retention policy**

The duration a partition store the data is configuable, by default it would be kept for a week. 
When the newest message in the segment is older than the retention period, then it would be a expired segment and deleted in the partition. 

#### **Producer Design**

![Produce-Design](https://typora-1302119905.cos.ap-nanjing.myqcloud.com/Coding/Producer-Design.png)

For each producer record, it would be serialised first and then the partitioner would decide which partition this message should go to. 

If the key in the record, then it would use round-robin to decide what to go defaultly, otherwise use function `hash(key) % number_of_partitions`  to decide which partition to put in the message

#### <a name="ProducerGuarantees">**Producer Guarantees**</a>

 ![Producer-Guarantees](https://typora-1302119905.cos.ap-nanjing.myqcloud.com/Coding/producer-guarantees.png)

There is three types of level to guarantees the writing of the message

1. Do not wait any ACK for any broker, just send the message and then send the next one directly.

   Data Losing: â­ï¸â­ï¸â­ï¸â­ï¸
   Latency: â­ï¸

2. Wait the ACK from the leader, the leader would send the ACK after it writing the message into the disk

   Data Losing: â­ï¸â­ï¸
   Latency: â­ï¸â­ï¸â­ï¸

3. Wait the ACK from the leader and the all followers

   Data Losing: â­ï¸
   Latency: â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸

#### **Customer Rebalances**

![Customer-Rebalances](https://typora-1302119905.cos.ap-nanjing.myqcloud.com/Coding/Customer-Rebalance.png)

#### **Compacted Topics**

When the consumer only want to know the lastest log message for a key(It measn for each message, it need to have a kep). The log only keep the newest value of a key

Compacted topic é€‚ç”¨äºå½“æ¶ˆè´¹è€…åªå…³æ³¨æ¯ä¸ªkeyæœ€æ–°çš„é‚£ä¸ªæ¶ˆæ¯ï¼Œå…¶ä»–ä¹‹å‰çš„æ¶ˆæ¯å¹¶ä¸å…³å¿ƒæ—¶ï¼Œä½¿ç”¨compacted topicåï¼ŒKafkaä¼šå®šæœŸå°†é‡å¤keyçš„â€˜æ—§â€™æ¶ˆæ¯åˆ é™¤ï¼Œå¹¶ä¸”æ¶ˆè´¹æ—¶æä¾›æœ€æ–°çš„æ¶ˆæ¯

## ç”Ÿäº§ç«¯(Producer)

1. [åº”ç­”æœºåˆ¶](#ProducerGuarantees)
   åº”ç­”æœºåˆ¶æœ‰ä¸‰ç§è®¾ç½®ï¼Œå„æœ‰åˆ©å¼Šï¼Œè¯¦æƒ…çœ‹é“¾æ¥
2. [æ•°æ®ä¸¢å¤±ä¸æ•°æ®é‡å¤](#æ•°æ®ä¸¢å¤±ä¸æ•°æ®é‡å¤ (Message Delivery))
3. [å¹‚ç­‰å‘é€è®¾è®¡çš„ä¼˜åŠ¿](#å¹‚ç­‰å‘é€è®¾è®¡çš„ä¼˜åŠ¿(Idempotence message sending))

1. Never send duplicate message, but maybe missing -> At most one
2. Never miss any message, but maybe duplicate -> At least one
3. Never miss and duplicate -> Exactly one

*Why we need exactly one?*

å¯¹äºä¸€äº›äº¤æ˜“ç³»ç»Ÿæ¥è¯´ï¼Œå¤šä¸€æ¬¡æ¶ˆè´¹æˆ–è€…å°‘ä¸€æ¬¡æ¶ˆè´¹éƒ½æ˜¯ä¸è¢«å…è®¸çš„ï¼Œè¿™æ—¶å€™ä¿è¯Exactly Oneå°±ååˆ†é‡è¦
For some system like trading system, duplicate trading message or missing trading message is not allowed, to gurantee exactly one is needed.

*How to achieve **At most one** or **At least one**?*

å°†åº”ç­”æœºåˆ¶ä¸­çš„ACKé…ç½®è®¾ç½®ä¸º0ï¼ŒKafkaè¿™æ—¶å€™å°±æ˜¯**At most one**çŠ¶æ€
å°†åº”ç­”æœºåˆ¶ä¸­çš„ACKé…ç½®è®¾ç½®ä¸º-1ï¼ŒKafkaè¿™æ—¶å€™æ˜¯**At lease one**çŠ¶æ€

*How to achieve **Exactly One** as producer sending messageï¼Ÿ*

At least one + å¹‚ç­‰ == Exactly One.  ä¸ºäº†ä¿è¯æ¶ˆæ¯ä¸é‡å¤è¢«å†™å…¥åº“ï¼ŒKafkaåœ¨producerç«¯å¼•å…¥äº†å¹‚ç­‰å¤„ç†ã€‚[ä»€ä¹ˆæ˜¯å¹‚ç­‰å¤„ç†ï¼Ÿ](https://zh.wikipedia.org/wiki/%E5%86%AA%E7%AD%89)
å¯¹äºæ¯ä¸ªProducerï¼Œåˆå§‹åŒ–æ—¶å€™èµ‹äºˆPIDï¼Œå¯¹äºå‘é€çš„æ¯ä¸ªæ¶ˆæ¯<Topic, Patition>éƒ½æœ‰ä¸€ä¸ªä»0å¼€å§‹çš„Sequence numberã€‚
åœ¨Brokeç«¯ï¼Œå¯¹äºæ¯ä¸ª<PID, Topic, Partition>éƒ½ç»´æŠ¤ä¸€ä¸ªåºåˆ—å·ï¼Œæ²¡æ”¶åˆ°ä¸€æ¬¡æ¶ˆæ¯è¯¥åºåˆ—å·+1ï¼Œæ”¶åˆ°æ¶ˆæ¯åï¼Œéœ€è¦æ ¡éªŒåºåˆ—å·æ˜¯å¦æ»¡è¶³è¯¥<PID, Topic, Partition>çš„æœ€å¤§åºåˆ—å·+1ï¼Œå¦‚æœä¸æ»¡è¶³ä¸æ¥å—è¯¥æ¶ˆæ¯

1. å¤§äºæœ€å¤§åºåˆ—å· + 1ï¼Œåˆ™è®¤ä¸ºæœ‰æ•°æ®è¿˜æ²¡å†™å…¥æˆ–è€…åœ¨ä¼ è¾“è·¯ä¸Šï¼Œè¯¥æ•°æ®ä¸ä¼šè¢«é‡‡çº³ï¼ŒæŠ›å‡ºInvalidSequenceNumber
2. å°äºæœ€å¤§åºåˆ—å· + 1ï¼Œåˆ™è®¤ä¸ºè¯¥æ•°æ®æ˜¯é‡å¤æ•°æ®ï¼ŒåŒæ ·ä¸è¢«é‡‡çº³ï¼ŒæŠ›å‡ºDuplicateSequenceNumberå¼‚å¸¸

#### å¹‚ç­‰å‘é€è®¾è®¡çš„ä¼˜åŠ¿(Idempotence message sending)

1. ä¿è¯æ¯ä¸ªpartitionä¸­çš„æ¶ˆæ¯æ˜¯æŒ‰é¡ºåºçš„ï¼Œå› ä¸ºä¸æŒ‰é¡ºåºä¼šè¢«æ‹’ç»å†™å…¥ç£ç›˜
2. ä¿è¯æ¯ä¸ªæ¶ˆæ¯ä¸ä¼šé‡å¤è¢«å†™å…¥ç£ç›˜å¯¼è‡´é‡å¤æ¶ˆè´¹

æ³¨æ„ï¼Œåœ¨ProduceråŠ å…¥äº†å¹‚ç­‰æ€§å‘é€çš„é…ç½®åï¼Œä»…ä»…èƒ½ä¿è¯å•ä¸ªProduceråœ¨åŒä¸€ä¸ªSessionä¸­å•Topicå•ä¸ªåˆ†åŒºç”Ÿäº§çš„æ•°æ®Exactly Oneï¼Œ

